FROM tensorflow/tensorflow:2.6.0-gpu
# FROM nvidia/cuda:10.1-cudnn7-runtime-ubuntu18.04
RUN rm /etc/apt/sources.list.d/cuda.list
RUN rm /etc/apt/sources.list.d/nvidia-ml.list
# System packages.
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libgl1-mesa-dev \
    python3-pip \
    unrar \
    wget \
    curl\
    unzip\
    && apt-get clean

# install Anaconda and dependencies
RUN curl -o ~/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    chmod +x ~/miniconda.sh && \
    ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh && \
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc


COPY . /app
COPY dreamerv2.yaml /src/dreamer.yaml
WORKDIR /app

# add conda paths
ENV PATH=/opt/conda/bin:$PATH 

# # build and activate conda environment
RUN /opt/conda/bin/conda env update -f dreamerv2.yaml
RUN echo "conda activate base" >> ~/.bashrc