FROM tensorflow/tensorflow:2.6.0-gpu
# FROM nvidia/cuda:10.1-cudnn7-runtime-ubuntu18.04
RUN rm /etc/apt/sources.list.d/cuda.list
RUN rm /etc/apt/sources.list.d/nvidia-ml.list
# System packages.
RUN apt-get update && apt-get install -y \
    ffmpeg \
    libgl1-mesa-dev \
    python3-pip \
    unrar \
    wget \
    curl\
    unzip\
    && apt-get clean

# install Anaconda and dependencies
RUN curl -o ~/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    chmod +x ~/miniconda.sh && \
    ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh && \
    ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc


COPY . /app
COPY dreamerv2.yaml /src/dreamer.yaml
WORKDIR /app

# add conda paths
ENV PATH=/opt/conda/bin:$PATH 

# # build and activate conda environment
RUN /opt/conda/bin/conda env update -f dreamerv2.yaml
RUN echo "conda activate base" >> ~/.bashrc
ENV PATH /opt/conda/envs/base/bin:$PATH

#RUN echo "conda install -c conda-forge cudatoolkit=11.2 cudnn=8.1.0 -y"

# RUN echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/"
# RUN echo "mkdir -p $CONDA_PREFIX/etc/conda/activate.d"
# RUN echo "echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/' > $CONDA_PREFIX/etc/conda/activate.d/env_vars.sh"
RUN echo "conda install -c conda-forge gym-atari -y"

WORKDIR /app/bonsai_benchmark_gym
RUN pip install -e . 
WORKDIR /app
# install MuJoCo
RUN mkdir -p /root/.mujoco \
    && wget https://www.roboti.us/download/mujoco200_linux.zip -O mujoco.zip \
    && unzip mujoco.zip -d /root/.mujoco \
    && mv /root/.mujoco/mujoco200_linux /root/.mujoco/mujoco200 \
    && rm mujoco.zip
#RUN wget -O /root/.mujoco/mjkey.txt https://www.roboti.us/mjkey.txt --header "Referer:www.roboti.us"
#RUN echo "$MUJOCO_KEY" > /root/.mujoco/mjkey.txt
COPY mjkey.txt /root/.mujoco/mjkey.txt
ENV LD_LIBRARY_PATH /root/.mujoco/mujoco200/bin:${LD_LIBRARY_PATH}

# #Atari ROMS.
# RUN mkdir roms && \
#     cd roms && \
#     wget http://www.atarimania.com/roms/Roms.rar && \
#     unrar e Roms.rar -y && \
#     #unzip ROMS.zip -y && \
#     #unzip "HC ROMS.zip" && \
#     #rm ROMS.zip && \
#     #rm "HC ROMS.zip" && \
#     rm Roms.rar  
# RUN   /opt/conda/envs/base/bin/python -m atari_py.import_roms .


RUN echo "conda env list"

CMD [ \
    "/opt/conda/envs/base/bin/python", "dreamerv2/train.py", \
    "--logdir", "/logdir/$(date +%Y%m%d-%H%M%S)", \
    "--configs", "defaults", "atari", \
    "--task", "atari_pong" \
    ]

